\section{Последовательный порт}

Последний кусочек аппаратной части этого задания - последовательный порт (UART).
В персональных компьютерах использовалось несколько разновидностей контроллеров
последовательных портов, собирательное название для них "семейство 8250", но на
этот раз уже не от компании Intel, а от National Semiconductor. Как и для других
интегральных схем для нее имеется документация: \cite{NS:8250DS} о проблемах
этой документации применительно к нашим задачам говорить уже излишне.

Последовательный порт может работать в двух режимах: с использованием прерываний
и опрашивая контроллер. Вам рекомендуется выбрать второй вариант по нескольким
причинам:
\begin{itemize}
  \item он проще;
  \item неизвестно в каком контексте вам понадобится выводить что-то в
        последовательный порт\footnote{Возможно вы захотите выводить какие-то
        логи в контексте, в котором прерывания отлючены.};
  \item нам не нужно (пока) чтение из последовательного порта;
  \item вы всегда сможете перейти к использованию прерываний в дальнейшем;
\end{itemize}

\subsection{Конфигурация последовательного порта}

По количеству разных внутренних регистров и опций конфигурации последовательный
порт заткнет запояс не один Legacy PIC, а целый каскад из 9 Legacy PIC-ов
\footnote{Максимальное количество PIC-ов в каскаде 9: 1 Master и 8 Slave.}.

Вы уже должны знать из чего, примерно, состоит конфигурация последовательного
интерфейса:

\begin{itemize}
  \item символьная скорость, обычно определяется коэффициентом деления некоторой
        базовой частоты;
  \item формат кадра, который включает количество бит данных, стоп бит и
        проверку четности;
  \item режим работы контроллера последовательного интерфейса (использовать
        прерывания или нет, читать или писать и тд) - зависимая от контроллера
        часть;
\end{itemize}

Как обычно настройка осуществляется через порты ввода/вывода, которые
соответсвуют каким-то внутренним регистрам контроллера. В нашем конкретном
случае для конфигурации последовательного порта используются порты ввода/вывода
начиная с 0x3f8 и до 0x3ff включительно\footnote{На самом деле порты
ввода/вывода последовательного порта могут находится и по другим адресам, но не
будем усложнять.}.

Пройдемся по порядку по портам и регистрам, на которые они отображены. Почти
самый простой регистр это регистр данных. Вы пишите в этот регистр то, что
хотите передать и читаете из него то, что получили. Этот регистр использует порт
0x3f8 + 0 (я буду использовать такую нотацию для обозначение отдельных портов
ввода/вывода последовательно порта). Этот же порт используется для записи и
чтения значения младшего байта коэффициента деления, как определяется на что
этот порт указывает в данный момент я расскажу дальше.

За прерывания отвечает Interrupt Enable Register, и для доступа к нему
используется порт 0x3f8 + 1. Отдельные биты этого регистра отвечают за
генерацию прерываний при тех или иных событиях. Если записать в регистр 0, то
контроллер не будет генерировать прерывания. И опять же, тот же самый порт
используется для доступа к старшему байту коэффициента деления.

Следущий важный для нас регистр это Line Control Register и он использует порт
0x3f8 + 3. Этот регистр выполняет две задачи\footnote{абсолютно друг с другом
не связанные}:
\begin{itemize}
  \item определяет куда в данный момент указывают порты 0x3f8 + 0 и 0x3f8 + 1;
  \item определеяет формат кадра;
\end{itemize}

За первую функцию отвечает 7 бит (начиная с 0) регистра LCR, также известный как
DLAB (Divisor Latch Access Bit). Если этот бит установлен в 1, то порты
0x3f8 + 0 и 0x3f8 + 1 укзаывают на младший и старший байты коэффициента деления.
В противном случае они указывают на регистр данных и Interrupt Enable Register,
соответственно.

Биты 0 и 1 Line Control Register отвечают за количество бит данных в формате
кадра. Чтобы использовать 8 бит данных вам нужно чтобы оба бита были выставленны
в 1.

Бит 2 отвечает за количество стоп бит, если вам нужен 1 стоп бит, то используйте
значение 0.

Биты 3-5 отвечают за проверку четности, если вам не нужна проверка четности, то
установите их значение в 0\footnote{Вообще, достаточно установить в 0 только
значение 3 бита.}.

Наконец Line Status Register позволяет проверить закончилась ли предыдущая
передача, или еще нужно подождать перед тем как писать в регистр данных
следующий байт. Этот регистр использует порт 0x3f8 + 5. Нас интересует в этом
регистре бит 5. Если этот бит установлен, значит можно записать следующий байт,
если этот бит сброшен, то нужно ждать.

Гораздо более подробная информация о последовательных портах в персональных
компьютерах их различных версиях, особенностях и разных режимах работы доступна
в~\cite{SERIAL}.
